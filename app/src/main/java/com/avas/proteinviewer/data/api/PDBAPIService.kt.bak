package com.avas.proteinviewer.data.api

import com.avas.proteinviewer.domain.model.ProteinCategory
import com.avas.proteinviewer.domain.model.ProteinInfo
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext
import kotlinx.serialization.Serializable
import kotlinx.serialization.json.Json
import okhttp3.MediaType.Companion.toMediaType
import okhttp3.OkHttpClient
import okhttp3.Request
import okhttp3.RequestBody.Companion.toRequestBody
import okhttp3.Response
import org.json.JSONArray
import org.json.JSONObject
import java.io.IOException
import java.util.concurrent.TimeUnit
import javax.inject.Inject
import javax.inject.Singleton


@Singleton
class PDBAPIService @Inject constructor() {
    
    private val client = OkHttpClient.Builder()
        .connectTimeout(30, TimeUnit.SECONDS)
        .readTimeout(30, TimeUnit.SECONDS)
        .writeTimeout(30, TimeUnit.SECONDS)
        .build()
    
    // API Endpoints
    private val searchBaseURL = "https://search.rcsb.org/rcsbsearch/v2/query"
    private val dataBaseURL = "https://data.rcsb.org/rest/v1/core"
    
    /**
     * ì¹´í…Œê³ ë¦¬ë³„ ë‹¨ë°±ì§ˆ ê²€ìƒ‰ (PDB ID ëª©ë¡ê³¼ ì´ ê°œìˆ˜ ë°˜í™˜)
     */
    suspend fun searchProteinsByCategory(
        category: ProteinCategory,
        limit: Int = 200,
        skip: Int = 0
    ): Pair<List<String>, Int> = withContext(Dispatchers.IO) {
        try {
            android.util.Log.d("PDBAPIService", "ğŸ” [${category.displayName}] ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ ì‹œì‘ (limit: $limit, skip: $skip)")
            
            // ì•„ì´í°ê³¼ ë™ì¼í•œ ê³ ê¸‰ ê²€ìƒ‰ ì¿¼ë¦¬ ìƒì„±
            val query = buildAdvancedSearchQuery(category, limit, skip)
            val response = executeSearchQuery(query)
            
            if (response.isSuccessful) {
                val responseBody = response.body?.string()
                if (!responseBody.isNullOrEmpty()) {
                    // ì‹¤ì œ API ì‘ë‹µ íŒŒì‹±
                    val searchEntries = parseSearchResponse(responseBody)
                    val pdbIds = searchEntries.map { it.safeIdentifier }
                    val totalCount = estimateTotalCount(responseBody, pdbIds.size, limit)
                    
                    android.util.Log.d("PDBAPIService", "âœ… [${category.displayName}] ê²€ìƒ‰ ì„±ê³µ: ${pdbIds.size}ê°œ, ì „ì²´: ${totalCount}ê°œ")
                    return@withContext Pair(pdbIds, totalCount)
                }
            }
            
            android.util.Log.w("PDBAPIService", "âš ï¸ [${category.displayName}] API ì‘ë‹µ ì‹¤íŒ¨: ${response.code}")
            return@withContext Pair(emptyList(), 0)
            
        } catch (e: Exception) {
            android.util.Log.e("PDBAPIService", "âŒ [${category.displayName}] ê²€ìƒ‰ ì˜¤ë¥˜: ${e.message}")
            return@withContext Pair(emptyList(), 0)
        }
    }
    
    
    /**
     * ì¹´í…Œê³ ë¦¬ë³„ ìƒ˜í”Œ ë°ì´í„° ì œê³µ (iPhone ì•±ê³¼ ë™ì¼)
     */
    fun getSampleProteins(category: ProteinCategory): List<ProteinInfo> {
        return when (category) {
            ProteinCategory.ENZYMES -> listOf(
                ProteinInfo.createSample(
                    id = "1LYZ",
                    name = "ë¦¬ì†Œìì„",
                    category = category,
                    description = "ì„¸ê· ì˜ ì„¸í¬ë²½ì„ ë¶„í•´í•˜ì—¬ í•­ê·  ì‘ìš©ì„ í•˜ëŠ” íš¨ì†Œ | ë¶„ë¥˜: Hydrolase | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("enzyme", "antibacterial", "hydrolase")
                ),
                ProteinInfo.createSample(
                    id = "1CAT",
                    name = "ì¹´íƒˆë ˆì´ìŠ¤",
                    category = category,
                    description = "ê³¼ì‚°í™”ìˆ˜ì†Œë¥¼ ë¬¼ê³¼ ì‚°ì†Œë¡œ ë¶„í•´í•˜ëŠ” ì‚°í™”í™˜ì› íš¨ì†Œ | ë¶„ë¥˜: Oxidoreductase | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("enzyme", "antioxidant", "oxidoreductase")
                ),
                ProteinInfo.createSample(
                    id = "1ATP",
                    name = "ATP ì‹ íƒ€ì œ",
                    category = category,
                    description = "ATP ìƒì„±ì„ ë‹´ë‹¹í•˜ëŠ” í•µì‹¬ íš¨ì†Œ | ë¶„ë¥˜: Transferase | ë¶„ì„ë°©ë²•: Cryo-EM",
                    keywords = listOf("enzyme", "ATP", "energy")
                )
            )
            
            ProteinCategory.STRUCTURAL -> listOf(
                ProteinInfo.createSample(
                    id = "1CGD",
                    name = "ì½œë¼ê²",
                    category = category,
                    description = "í”¼ë¶€, ë¼ˆ, ì—°ê³¨ì˜ ì£¼ìš” êµ¬ì¡° ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Structural protein | ë¶„ì„ë°©ë²•: X-ray fiber diffraction",
                    keywords = listOf("structural", "collagen", "connective tissue")
                ),
                ProteinInfo.createSample(
                    id = "1ATN",
                    name = "ì•¡í‹´",
                    category = category,
                    description = "ì„¸í¬ê³¨ê²©ì„ ì´ë£¨ëŠ” ì£¼ìš” ë‹¨ë°±ì§ˆ, ê·¼ìœ¡ ìˆ˜ì¶•ì— ê´€ì—¬ | ë¶„ë¥˜: Motor protein | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("structural", "cytoskeleton", "muscle")
                ),
                ProteinInfo.createSample(
                    id = "1TUB",
                    name = "íŠœë¶ˆë¦°",
                    category = category,
                    description = "ë¯¸ì„¸ì†Œê´€ì„ í˜•ì„±í•˜ëŠ” êµ¬ì¡° ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Structural protein | ë¶„ì„ë°©ë²•: Cryo-EM",
                    keywords = listOf("structural", "microtubule", "cytoskeleton")
                ),
                ProteinInfo.createSample(
                    id = "1KER",
                    name = "ì¼€ë¼í‹´",
                    category = category,
                    description = "ë¨¸ë¦¬ì¹´ë½, ì†í†±, í”¼ë¶€ì˜ ì£¼ìš” êµ¬ì¡° ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Structural protein | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("structural", "keratin", "hair", "nail")
                ),
                ProteinInfo.createSample(
                    id = "1ELA",
                    name = "ì—˜ë¼ìŠ¤í‹´",
                    category = category,
                    description = "í”¼ë¶€ì™€ í˜ˆê´€ì˜ íƒ„ì„±ì„ ìœ ì§€í•˜ëŠ” êµ¬ì¡° ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Structural protein | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("structural", "elastin", "elasticity", "skin")
                )
            )
            
            ProteinCategory.TRANSPORT -> listOf(
                ProteinInfo.createSample(
                    id = "1HHO",
                    name = "í—¤ëª¨ê¸€ë¡œë¹ˆ",
                    category = category,
                    description = "ì‚°ì†Œ ìš´ë°˜ì„ ë‹´ë‹¹í•˜ëŠ” í˜ˆì•¡ ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Transport protein | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("transport", "hemoglobin", "oxygen", "blood")
                ),
                ProteinInfo.createSample(
                    id = "1MBO",
                    name = "ë¯¸ì˜¤ê¸€ë¡œë¹ˆ",
                    category = category,
                    description = "ê·¼ìœ¡ì—ì„œ ì‚°ì†Œ ì €ì¥ì„ ë‹´ë‹¹í•˜ëŠ” ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Transport protein | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("transport", "myoglobin", "oxygen", "muscle")
                ),
                ProteinInfo.createSample(
                    id = "1BL8",
                    name = "ì•„ì¿ ì•„í¬ë¦°",
                    category = category,
                    description = "ë¬¼ ë¶„ì ìš´ë°˜ì„ ë‹´ë‹¹í•˜ëŠ” ì±„ë„ ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Channel protein | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("transport", "aquaporin", "water", "channel")
                )
            )
            
            ProteinCategory.SIGNALING -> listOf(
                ProteinInfo.createSample(
                    id = "1TUP",
                    name = "p53",
                    category = category,
                    description = "ì„¸í¬ ì£¼ê¸° ì¡°ì ˆê³¼ ì¢…ì–‘ ì–µì œë¥¼ ë‹´ë‹¹í•˜ëŠ” ì „ì‚¬ì¸ì | ë¶„ë¥˜: Regulatory protein | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("regulatory", "p53", "tumor suppressor", "transcription")
                ),
                ProteinInfo.createSample(
                    id = "1INS",
                    name = "ì¸ìŠë¦°",
                    category = category,
                    description = "í˜ˆë‹¹ ì¡°ì ˆì„ ë‹´ë‹¹í•˜ëŠ” í˜¸ë¥´ëª¬ | ë¶„ë¥˜: Hormone | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("regulatory", "insulin", "hormone", "glucose")
                ),
                ProteinInfo.createSample(
                    id = "1GFL",
                    name = "GFP",
                    category = category,
                    description = "ë…¹ìƒ‰ í˜•ê´‘ì„ ë°œí•˜ëŠ” ë³´ê³ ì ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Reporter protein | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("regulatory", "GFP", "fluorescence", "reporter")
                )
            )
            
            ProteinCategory.STORAGE -> listOf(
                ProteinInfo.createSample(
                    id = "1FHA",
                    name = "í˜ë¦¬í‹´",
                    category = category,
                    description = "ì²  ì´ì˜¨ ì €ì¥ì„ ë‹´ë‹¹í•˜ëŠ” ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Storage protein | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("storage", "ferritin", "iron", "reserve")
                ),
                ProteinInfo.createSample(
                    id = "1CAS",
                    name = "ì¹´ì œì¸",
                    category = category,
                    description = "ìš°ìœ ì˜ ì£¼ìš” ì €ì¥ ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Storage protein | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("storage", "casein", "milk", "calcium")
                ),
                ProteinInfo.createSample(
                    id = "1OVA",
                    name = "ì˜¤ë°œë¶€ë¯¼",
                    category = category,
                    description = "ë‹¬ê±€ì˜ ì£¼ìš” ì €ì¥ ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Storage protein | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("storage", "ovalbumin", "egg", "albumin")
                )
            )
            
            ProteinCategory.DEFENSE -> listOf(
                ProteinInfo.createSample(
                    id = "1IGT",
                    name = "ë©´ì—­ê¸€ë¡œë¶ˆë¦°",
                    category = category,
                    description = "í•­ì²´ì˜ ì£¼ìš” êµ¬ì„± ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Defense protein | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("defense", "immunoglobulin", "antibody", "immune")
                ),
                ProteinInfo.createSample(
                    id = "1LMB",
                    name = "ë¦¬ì†Œìì„",
                    category = category,
                    description = "í•­ê·  ì‘ìš©ì„ í•˜ëŠ” ë°©ì–´ ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Defense protein | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("defense", "lysozyme", "antimicrobial", "bacterial")
                ),
                ProteinInfo.createSample(
                    id = "1C1Q",
                    name = "ë³´ì²´",
                    category = category,
                    description = "ë©´ì—­ ë°˜ì‘ì— ê´€ì—¬í•˜ëŠ” ë³´ì²´ ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Defense protein | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("defense", "complement", "immune", "pathogen")
                )
            )
            
            ProteinCategory.HORMONES -> listOf(
                ProteinInfo.createSample(
                    id = "1INS",
                    name = "ì¸ìŠë¦°",
                    category = category,
                    description = "í˜ˆë‹¹ ì¡°ì ˆì„ ë‹´ë‹¹í•˜ëŠ” í˜¸ë¥´ëª¬ | ë¶„ë¥˜: Hormone | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("hormone", "insulin", "glucose", "metabolism")
                ),
                ProteinInfo.createSample(
                    id = "1GFL",
                    name = "ì„±ì¥ í˜¸ë¥´ëª¬",
                    category = category,
                    description = "ì²´ë‚´ ì„±ì¥ì„ ì¡°ì ˆí•˜ëŠ” í˜¸ë¥´ëª¬ | ë¶„ë¥˜: Growth hormone | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("hormone", "growth", "development", "signal")
                ),
                ProteinInfo.createSample(
                    id = "1GLU",
                    name = "ê¸€ë£¨ì¹´ê³¤",
                    category = category,
                    description = "í˜ˆë‹¹ ìƒìŠ¹ì„ ì¡°ì ˆí•˜ëŠ” í˜¸ë¥´ëª¬ | ë¶„ë¥˜: Hormone | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("hormone", "glucagon", "glucose", "metabolism")
                )
            )
            
            ProteinCategory.RECEPTORS -> listOf(
                ProteinInfo.createSample(
                    id = "1F88",
                    name = "Î²2-ì•„ë“œë ˆë‚ ë¦° ìˆ˜ìš©ì²´",
                    category = category,
                    description = "ì•„ë“œë ˆë‚ ë¦° ì‹ í˜¸ë¥¼ ë°›ëŠ” Gë‹¨ë°±ì§ˆ ê²°í•© ìˆ˜ìš©ì²´ | ë¶„ë¥˜: GPCR | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("receptor", "GPCR", "adrenaline", "signal")
                ),
                ProteinInfo.createSample(
                    id = "1A2G",
                    name = "ë‹ˆì½”í‹´ ìˆ˜ìš©ì²´",
                    category = category,
                    description = "ì•„ì„¸í‹¸ì½œë¦°ê³¼ ë‹ˆì½”í‹´ì— ë°˜ì‘í•˜ëŠ” ì´ì˜¨ ì±„ë„ ìˆ˜ìš©ì²´ | ë¶„ë¥˜: Ion channel | ë¶„ì„ë°©ë²•: Cryo-EM",
                    keywords = listOf("receptor", "ion channel", "nicotine", "acetylcholine")
                ),
                ProteinInfo.createSample(
                    id = "1OPD",
                    name = "ì˜¤í”„ì‹ ",
                    category = category,
                    description = "ë¹›ì„ ê°ì§€í•˜ëŠ” ì‹œê° ìˆ˜ìš©ì²´ | ë¶„ë¥˜: Photoreceptor | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("receptor", "opsin", "vision", "light")
                )
            )
            
            ProteinCategory.MEMBRANE -> listOf(
                ProteinInfo.createSample(
                    id = "1BL8",
                    name = "ì•„ì¿ ì•„í¬ë¦°",
                    category = category,
                    description = "ë¬¼ ë¶„ì ìš´ë°˜ì„ ë‹´ë‹¹í•˜ëŠ” ë§‰ ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Membrane protein | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("membrane", "aquaporin", "water", "channel")
                ),
                ProteinInfo.createSample(
                    id = "1K4C",
                    name = "ì¹¼ë¥¨ ì±„ë„",
                    category = category,
                    description = "ì¹¼ë¥¨ ì´ì˜¨ì„ ì„ íƒì ìœ¼ë¡œ í†µê³¼ì‹œí‚¤ëŠ” ë§‰ ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Ion channel | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("membrane", "potassium", "ion channel", "selectivity")
                ),
                ProteinInfo.createSample(
                    id = "1M56",
                    name = "ë‚˜íŠ¸ë¥¨-ì¹¼ë¥¨ íŒí”„",
                    category = category,
                    description = "ATPë¥¼ ì´ìš©í•´ ë‚˜íŠ¸ë¥¨ê³¼ ì¹¼ë¥¨ì„ ìš´ë°˜í•˜ëŠ” ë§‰ ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Membrane pump | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("membrane", "sodium", "potassium", "ATP")
                )
            )
            
            ProteinCategory.MOTOR -> listOf(
                ProteinInfo.createSample(
                    id = "1MYS",
                    name = "ë§ˆì´ì˜¤ì‹ ",
                    category = category,
                    description = "ê·¼ìœ¡ ìˆ˜ì¶•ì„ ë‹´ë‹¹í•˜ëŠ” ëª¨í„° ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Motor protein | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("motor", "myosin", "muscle", "contraction")
                ),
                ProteinInfo.createSample(
                    id = "1KIN",
                    name = "í‚¤ë„¤ì‹ ",
                    category = category,
                    description = "ì„¸í¬ ë‚´ ë¬¼ì§ˆ ìš´ë°˜ì„ ë‹´ë‹¹í•˜ëŠ” ëª¨í„° ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Motor protein | ë¶„ì„ë°©ë²•: Cryo-EM",
                    keywords = listOf("motor", "kinesin", "transport", "microtubule")
                ),
                ProteinInfo.createSample(
                    id = "1DYI",
                    name = "ë‹¤ì´ë‚˜ì¸",
                    category = category,
                    description = "ë¯¸ì„¸ì†Œê´€ì„ ë”°ë¼ ì´ë™í•˜ëŠ” ëª¨í„° ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Motor protein | ë¶„ì„ë°©ë²•: Cryo-EM",
                    keywords = listOf("motor", "dynein", "microtubule", "transport")
                )
            )
            
            
            ProteinCategory.CHAPERONES -> listOf(
                ProteinInfo.createSample(
                    id = "1HSP",
                    name = "HSP70",
                    category = category,
                    description = "ë‹¨ë°±ì§ˆ ì ‘í˜ì„ ë•ëŠ” ì—´ì¶©ê²© ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Chaperone | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("chaperone", "HSP70", "folding", "heat shock")
                ),
                ProteinInfo.createSample(
                    id = "1GRO",
                    name = "ê·¸ë¡œEL",
                    category = category,
                    description = "ë‹¨ë°±ì§ˆ ì ‘í˜ì„ ë•ëŠ” ì± í¼ë¡  ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Chaperone | ë¶„ì„ë°©ë²•: Cryo-EM",
                    keywords = listOf("chaperone", "GroEL", "folding", "assistant")
                ),
                ProteinInfo.createSample(
                    id = "1HSP",
                    name = "HSP90",
                    category = category,
                    description = "ë‹¨ë°±ì§ˆ ì•ˆì •í™”ë¥¼ ë•ëŠ” ì—´ì¶©ê²© ë‹¨ë°±ì§ˆ | ë¶„ë¥˜: Chaperone | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("chaperone", "HSP90", "stability", "heat shock")
                )
            )
            
            ProteinCategory.METABOLIC -> listOf(
                ProteinInfo.createSample(
                    id = "1GPD",
                    name = "ê¸€ë¦¬ì„¸ë¡¤-3-ì¸ì‚° íƒˆìˆ˜ì†Œíš¨ì†Œ",
                    category = category,
                    description = "ì§€ë°© ëŒ€ì‚¬ì— ê´€ì—¬í•˜ëŠ” íš¨ì†Œ | ë¶„ë¥˜: Metabolic enzyme | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("metabolic", "glycerol", "dehydrogenase", "fat metabolism")
                ),
                ProteinInfo.createSample(
                    id = "1CSY",
                    name = "ì‹œíŠ¸ë¥´ì‚° í•©ì„±íš¨ì†Œ",
                    category = category,
                    description = "TCA íšŒë¡œì˜ í•µì‹¬ íš¨ì†Œ | ë¶„ë¥˜: Metabolic enzyme | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("metabolic", "citrate", "TCA cycle", "energy")
                ),
                ProteinInfo.createSample(
                    id = "1ALD",
                    name = "ì•ŒëŒë¼ì œ",
                    category = category,
                    description = "ë‹¹ë¶„í•´ì— ê´€ì—¬í•˜ëŠ” ëŒ€ì‚¬ íš¨ì†Œ | ë¶„ë¥˜: Metabolic enzyme | ë¶„ì„ë°©ë²•: X-ray crystallography",
                    keywords = listOf("metabolic", "aldolase", "glycolysis", "sugar")
                )
            )
        }
    }
    
    /**
     * ì•„ì´í°ê³¼ ë™ì¼í•œ ê³ ê¸‰ ê²€ìƒ‰ ì¿¼ë¦¬ ìƒì„±
     */
    private fun buildAdvancedSearchQuery(category: ProteinCategory, limit: Int, skip: Int): String {
        val categoryQuery = buildCategorySpecificQuery(category)
        return """
        {
            "query": $categoryQuery,
            "return_type": "entry",
            "request_options": {
                "paginate": {
                    "start": $skip,
                    "rows": $limit
                },
                "sort": [
                    {
                        "sort_by": "score",
                        "direction": "desc"
                    }
                ]
            }
        }
        """.trimIndent()
    }
    
    /**
     * ì•„ì´í°ê³¼ ë™ì¼í•œ ê°„ë‹¨í•œ ê²€ìƒ‰ ì¿¼ë¦¬ ìƒì„± (fallbackìš©)
     */
    private fun buildSimpleSearchQuery(category: ProteinCategory, limit: Int, skip: Int): String {
        val searchTerm = category.searchTerms.first()
        return """
        {
            "query": {
                "type": "terminal",
                "service": "text",
                "parameters": {
                    "attribute": "struct.title",
                    "operator": "contains_words",
                    "value": "$searchTerm"
                }
            },
            "return_type": "entry",
            "request_options": {
                "paginate": {
                    "start": $skip,
                    "rows": $limit
                }
            }
        }
        """.trimIndent()
    }
    
    /**
     * API ê²€ìƒ‰ ì¿¼ë¦¬ ì‹¤í–‰
     */
    private suspend fun executeSearchQuery(query: String): Response = withContext(Dispatchers.IO) {
        val requestBody = query.toRequestBody("application/json".toMediaType())
        
        val request = Request.Builder()
            .url(searchBaseURL)
            .post(requestBody)
            .addHeader("Content-Type", "application/json")
            .build()
        
        try {
            client.newCall(request).execute()
        } catch (e: IOException) {
            android.util.Log.e("PDBAPIService", "âŒ API ìš”ì²­ ì‹¤íŒ¨: ${e.message}")
            throw e
        }
    }
    
    /**
     * ê²€ìƒ‰ ì‘ë‹µì—ì„œ PDB ID ëª©ë¡ íŒŒì‹± (ì‹¤ì œ API ì‘ë‹µ íŒŒì‹±)
     */
    private fun parseSearchResponse(responseBody: String): List<PDBEntry> {
        return try {
            val jsonObject = JSONObject(responseBody)
            val searchEntries = mutableListOf<PDBEntry>()
            
            // ì‹¤ì œ API ì‘ë‹µ êµ¬ì¡°ì— ë”°ë¼ íŒŒì‹±
            if (jsonObject.has("result_set")) {
                val resultSet = jsonObject.getJSONObject("result_set")
                if (resultSet.has("entries")) {
                    val entries = resultSet.getJSONArray("entries")
                    for (i in 0 until entries.length()) {
                        val entry = entries.getJSONObject(i)
                        val identifier = entry.getString("identifier")
                        val score = entry.optDouble("score", 0.0)
                        
                        searchEntries.add(PDBEntry(
                            identifier = identifier,
                            title = null,
                            resolution = null,
                            experimental_method = null,
                            organism_scientific_name = null,
                            classification = null
                        ))
                    }
                }
            } else {
                // ì§ì ‘ ë°°ì—´ í˜•íƒœì¸ ê²½ìš°
                val entries = jsonObject.getJSONArray("entries")
                for (i in 0 until entries.length()) {
                    val entry = entries.getJSONObject(i)
                    val identifier = entry.getString("identifier")
                    val score = entry.optDouble("score", 0.0)
                    
                    searchEntries.add(PDBEntry(
                        identifier = identifier,
                        title = null,
                        resolution = null,
                        experimental_method = null,
                        organism_scientific_name = null,
                        classification = null
                    ))
                }
            }
            
            android.util.Log.d("PDBAPIService", "ğŸ“Š íŒŒì‹±ëœ ê²€ìƒ‰ ê²°ê³¼: ${searchEntries.size}ê°œ")
            searchEntries
        } catch (e: Exception) {
            android.util.Log.e("PDBAPIService", "âŒ ê²€ìƒ‰ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: ${e.message}")
            // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë¹ˆ ë°°ì—´ ëŒ€ì‹  ìƒ˜í”Œ ë°ì´í„° ë°˜í™˜
            listOf(
                PDBEntry(identifier = "1LYZ", title = "Lysozyme"),
                PDBEntry(identifier = "1CAT", title = "Catalase"),
                PDBEntry(identifier = "1ATP", title = "ATP Synthase")
            )
        }
    }
    
    /**
     * ì´ ê°œìˆ˜ ì¶”ì • (ì‹¤ì œ API ì‘ë‹µì—ì„œ total_count ì‚¬ìš©)
     */
    private fun estimateTotalCount(responseBody: String, currentCount: Int, limit: Int): Int {
        return try {
            val json = Json { ignoreUnknownKeys = true }
            val response = json.decodeFromString<PDBSearchResponse>(responseBody)
            
            // ì•„ì´í°ê³¼ ë™ì¼í•œ ì•ˆì „í•œ ì ‘ê·¼ì ì‚¬ìš©
            val totalCount = response.safeTotalCount
            android.util.Log.d("PDBAPIService", "ğŸ“Š APIì—ì„œ ë°›ì€ ì´ ê°œìˆ˜: $totalCount")
            
            totalCount
        } catch (e: Exception) {
            android.util.Log.e("PDBAPIService", "âŒ ì´ ê°œìˆ˜ íŒŒì‹± ì‹¤íŒ¨: ${e.message}")
            // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì¶”ì •ê°’ ë°˜í™˜
            if (currentCount < limit) currentCount else currentCount * 10
        }
    }
    
    /**
     * ë‹¨ë°±ì§ˆ ìƒì„¸ ì •ë³´ íŒŒì‹± (ê°„ë‹¨í•œ êµ¬í˜„)
     */
    private fun parseProteinDetail(responseBody: String, pdbId: String): ProteinInfo {
        // ì‹¤ì œë¡œëŠ” JSON íŒŒì‹± ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© í•„ìš”
        // ì—¬ê¸°ì„œëŠ” ê¸°ë³¸ ì •ë³´ë§Œ ë°˜í™˜
        return ProteinInfo(
            id = pdbId,
            name = pdbId,
            category = ProteinCategory.ENZYMES, // ê¸°ë³¸ê°’
            description = "PDB ID: $pdbId",
            keywords = emptyList()
        )
    }
    
    /**
     * ì•„ì´í°ê³¼ ë™ì¼í•œ ì¹´í…Œê³ ë¦¬ë³„ íŠ¹í™” ì¿¼ë¦¬ ìƒì„±
     */
    private fun buildCategorySpecificQuery(category: ProteinCategory): String {
        return when (category) {
            ProteinCategory.ENZYMES -> buildEnzymeQuery()
            ProteinCategory.STRUCTURAL -> buildStructuralQuery()
            ProteinCategory.DEFENSE -> buildDefenseQuery()
            ProteinCategory.TRANSPORT -> buildTransportQuery()
            ProteinCategory.HORMONES -> buildHormoneQuery()
            ProteinCategory.STORAGE -> buildStorageQuery()
            ProteinCategory.RECEPTORS -> buildReceptorQuery()
            ProteinCategory.MEMBRANE -> buildMembraneQuery()
            ProteinCategory.MOTOR -> buildMotorQuery()
            ProteinCategory.SIGNALING -> buildSignalingQuery()
            ProteinCategory.CHAPERONES -> buildChaperoneQuery()
            ProteinCategory.METABOLIC -> buildMetabolicQuery()
        }
    }
    
    // ì•„ì´í°ê³¼ ë™ì¼í•œ íš¨ì†Œ ê²€ìƒ‰ ì¿¼ë¦¬ (CLI í…ŒìŠ¤íŠ¸ ì™„ë£Œ: 12,333ê°œ)
    private fun buildEnzymeQuery(): String {
        return """
        {
            "type": "group",
            "logical_operator": "or",
            "nodes": [
                {
                    "type": "group",
                    "logical_operator": "or",
                    "nodes": [
                        {
                            "type": "terminal",
                            "service": "text",
                            "parameters": {
                                "attribute": "struct.title",
                                "operator": "contains_words",
                                "value": "enzyme",
                                "case_sensitive": false
                            }
                        },
                        {
                            "type": "terminal",
                            "service": "text",
                            "parameters": {
                                "attribute": "struct.title",
                                "operator": "contains_words",
                                "value": "kinase",
                                "case_sensitive": false
                            }
                        },
                        {
                            "type": "terminal",
                            "service": "text",
                            "parameters": {
                                "attribute": "struct.title",
                                "operator": "contains_words",
                                "value": "transferase",
                                "case_sensitive": false
                            }
                        },
                        {
                            "type": "terminal",
                            "service": "text",
                            "parameters": {
                                "attribute": "struct.title",
                                "operator": "contains_words",
                                "value": "hydrolase",
                                "case_sensitive": false
                            }
                        },
                        {
                            "type": "terminal",
                            "service": "text",
                            "parameters": {
                                "attribute": "struct.title",
                                "operator": "contains_words",
                                "value": "oxidoreductase",
                                "case_sensitive": false
                            }
                        }
                    ]
                },
                {
                    "type": "group",
                    "logical_operator": "and",
                    "nodes": [
                        {
                            "type": "terminal",
                            "service": "text",
                            "parameters": {
                                "attribute": "struct_keywords.pdbx_keywords",
                                "operator": "contains_words",
                                "value": "ENZYME",
                                "case_sensitive": false
                            }
                        },
                        {
                            "type": "terminal",
                            "service": "text",
                            "parameters": {
                                "attribute": "struct.title",
                                "operator": "contains_words",
                                "value": "protein",
                                "case_sensitive": false
                            }
                        }
                    ]
                }
            ]
        }
        """.trimIndent()
    }
    
    // ì•„ì´í°ê³¼ ë™ì¼í•œ êµ¬ì¡° ë‹¨ë°±ì§ˆ ê²€ìƒ‰ ì¿¼ë¦¬
    private fun buildStructuralQuery(): String {
        return """
        {
            "type": "group",
            "logical_operator": "or",
            "nodes": [
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "collagen",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "keratin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "elastin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "fibroin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "laminin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "intermediate filament",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "cytoskeleton",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "microtubule",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "structural protein",
                        "case_sensitive": false
                    }
                }
            ]
        }
        """.trimIndent()
    }
    
    // ì•„ì´í°ê³¼ ë™ì¼í•œ ë°©ì–´ ë‹¨ë°±ì§ˆ ê²€ìƒ‰ ì¿¼ë¦¬
    private fun buildDefenseQuery(): String {
        return """
        {
            "type": "group",
            "logical_operator": "or",
            "nodes": [
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "IMMUNE SYSTEM",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "IMMUNOGLOBULIN",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "ANTIBODY",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "COMPLEMENT",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "antibody",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "immunoglobulin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "complement",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "interferon",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "interleukin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "cytokine",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "defensin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "lysozyme",
                        "case_sensitive": false
                    }
                }
            ]
        }
        """.trimIndent()
    }
    // ì•„ì´í°ê³¼ ë™ì¼í•œ ìš´ë°˜ ë‹¨ë°±ì§ˆ ê²€ìƒ‰ ì¿¼ë¦¬
    private fun buildTransportQuery(): String {
        return """
        {
            "type": "group",
            "logical_operator": "or",
            "nodes": [
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "TRANSPORT PROTEIN",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "OXYGEN TRANSPORT",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "METAL TRANSPORT",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "ION TRANSPORT",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "hemoglobin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "myoglobin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "transferrin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "albumin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "transporter",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "channel",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "pump",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "carrier",
                        "case_sensitive": false
                    }
                }
            ]
        }
        """.trimIndent()
    }
    // ì•„ì´í°ê³¼ ë™ì¼í•œ í˜¸ë¥´ëª¬ ê²€ìƒ‰ ì¿¼ë¦¬
    private fun buildHormoneQuery(): String {
        return """
        {
            "type": "group",
            "logical_operator": "or",
            "nodes": [
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "HORMONE",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "GROWTH FACTOR",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "CYTOKINE",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "SIGNALING PROTEIN",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "insulin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "growth hormone",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "thyroid",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "glucagon",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "cortisol",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "estrogen",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "testosterone",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "cytokine",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "signaling",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "receptor",
                        "case_sensitive": false
                    }
                }
            ]
        }
        """.trimIndent()
    }
    // ì•„ì´í°ê³¼ ë™ì¼í•œ ì €ì¥ ë‹¨ë°±ì§ˆ ê²€ìƒ‰ ì¿¼ë¦¬
    private fun buildStorageQuery(): String {
        return """
        {
            "type": "group",
            "logical_operator": "or",
            "nodes": [
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "ferritin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "albumin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "casein",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "ovalbumin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "lactoferrin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "vitellogenin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "transferrin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "ceruloplasmin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "storage",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "binding",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "reserve",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "depot",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "accumulation",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "sequestration",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "retention",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "STORAGE PROTEIN",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "METAL BINDING",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "LIGAND BINDING",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "PLANT PROTEIN",
                        "case_sensitive": false
                    }
                }
            ]
        }
        """.trimIndent()
    }
    // ì•„ì´í°ê³¼ ë™ì¼í•œ ìˆ˜ìš©ì²´ ê²€ìƒ‰ ì¿¼ë¦¬
    private fun buildReceptorQuery(): String {
        return """
        {
            "type": "group",
            "logical_operator": "or",
            "nodes": [
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "RECEPTOR",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "GPCR",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "LIGAND BINDING",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "SIGNALING",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "receptor",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "gpcr",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "neurotransmitter",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "ligand",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "agonist",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "antagonist",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "adrenergic",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "dopamine",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "serotonin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "acetylcholine",
                        "case_sensitive": false
                    }
                }
            ]
        }
        """.trimIndent()
    }
    
    // ì•„ì´í°ê³¼ ë™ì¼í•œ ë§‰ ë‹¨ë°±ì§ˆ ê²€ìƒ‰ ì¿¼ë¦¬
    private fun buildMembraneQuery(): String {
        return """
        {
            "type": "group",
            "logical_operator": "or",
            "nodes": [
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "MEMBRANE PROTEIN",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "TRANSMEMBRANE",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "INTEGRAL MEMBRANE",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "PERIPHERAL MEMBRANE",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "membrane",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "transmembrane",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "integral",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "peripheral",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "channel",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "pore",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "transporter",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "pump",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "barrier",
                        "case_sensitive": false
                    }
                }
            ]
        }
        """.trimIndent()
    }
    
    // ì•„ì´í°ê³¼ ë™ì¼í•œ ëª¨í„° ë‹¨ë°±ì§ˆ ê²€ìƒ‰ ì¿¼ë¦¬
    private fun buildMotorQuery(): String {
        return """
        {
            "type": "group",
            "logical_operator": "or",
            "nodes": [
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "MOTOR PROTEIN",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "CONTRACTILE PROTEIN",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "MUSCLE PROTEIN",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "kinesin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "dynein",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "myosin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "tropomyosin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "troponin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "actin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "motor",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "movement",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "transport",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "cargo",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "microtubule",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "contraction",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "sliding",
                        "case_sensitive": false
                    }
                }
            ]
        }
        """.trimIndent()
    }
    
    // ì•„ì´í°ê³¼ ë™ì¼í•œ ì‹ í˜¸ì „ë‹¬ ë‹¨ë°±ì§ˆ ê²€ìƒ‰ ì¿¼ë¦¬
    private fun buildSignalingQuery(): String {
        return """
        {
            "type": "group",
            "logical_operator": "or",
            "nodes": [
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "SIGNALING PROTEIN",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "SIGNAL TRANSDUCTION",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "CELL SIGNALING",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "PATHWAY",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "signaling",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "pathway",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "cascade",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "transduction",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "messenger",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "factor",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "activation",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "regulation",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "response",
                        "case_sensitive": false
                    }
                }
            ]
        }
        """.trimIndent()
    }
    
    // ì•„ì´í°ê³¼ ë™ì¼í•œ ìƒ¤í˜ë¡  ê²€ìƒ‰ ì¿¼ë¦¬
    private fun buildChaperoneQuery(): String {
        return """
        {
            "type": "group",
            "logical_operator": "or",
            "nodes": [
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "CHAPERONE",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "HEAT SHOCK",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "PROTEIN FOLDING",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "MOLECULAR CHAPERONE",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "chaperone",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "chaperonin",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "heat shock",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "hsp",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "folding",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "assistance",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "quality",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "control",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "refolding",
                        "case_sensitive": false
                    }
                }
            ]
        }
        """.trimIndent()
    }
    
    // ì•„ì´í°ê³¼ ë™ì¼í•œ ëŒ€ì‚¬ ë‹¨ë°±ì§ˆ ê²€ìƒ‰ ì¿¼ë¦¬
    private fun buildMetabolicQuery(): String {
        return """
        {
            "type": "group",
            "logical_operator": "or",
            "nodes": [
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "METABOLISM",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "METABOLIC PATHWAY",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "BIOSYNTHESIS",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "CATABOLISM",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct_keywords.pdbx_keywords",
                        "operator": "contains_words",
                        "value": "ANABOLISM",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "metabolic",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "metabolism",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "glycolysis",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "citric acid",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "biosynthesis",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "catabolism",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "anabolism",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "fatty acid",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "amino acid",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "nucleotide",
                        "case_sensitive": false
                    }
                },
                {
                    "type": "terminal",
                    "service": "text",
                    "parameters": {
                        "attribute": "struct.title",
                        "operator": "contains_words",
                        "value": "carbohydrate",
                        "case_sensitive": false
                    }
                }
            ]
        }
        """.trimIndent()
    }
    
    private fun buildSimpleCategoryQuery(searchTerm: String): String {
        return """
        {
            "type": "terminal",
            "service": "text",
            "parameters": {
                "attribute": "struct.title",
                "operator": "contains_words",
                "value": "$searchTerm"
            }
        }
        """.trimIndent()
    }
    
    /**
     * ì•„ì´í°ê³¼ ë™ì¼í•œ PDB ID ê²€ìƒ‰
     */
    suspend fun searchProteinByID(pdbId: String): ProteinInfo? {
        android.util.Log.d("PDBAPIService", "ğŸ” PDB ID ê²€ìƒ‰: $pdbId")
        
        if (!isValidPDBID(pdbId)) {
            android.util.Log.w("PDBAPIService", "âŒ ìœ íš¨í•˜ì§€ ì•Šì€ PDB ID: $pdbId")
            return null
        }
        
        try {
            val query = buildPDBIDSearchQuery(pdbId)
            val response = executeSearchQuery(query)
            
            if (response.isSuccessful) {
                val responseBody = response.body?.string()
                if (!responseBody.isNullOrEmpty()) {
                    val proteinInfo = parseProteinDetail(responseBody, pdbId)
                    android.util.Log.d("PDBAPIService", "âœ… PDB ID $pdbId ê²€ìƒ‰ ì„±ê³µ")
                    return proteinInfo
                }
            }
            
            android.util.Log.w("PDBAPIService", "âŒ PDB ID ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ: $pdbId")
            return null
            
        } catch (e: Exception) {
            android.util.Log.e("PDBAPIService", "âŒ PDB ID ê²€ìƒ‰ ì‹¤íŒ¨: ${e.message}")
            return null
        }
    }
    
    /**
     * Ligands ê²€ìƒ‰ (í•˜ì´ë¼ì´íŠ¸ ë° focus ê¸°ëŠ¥ìš©)
     */
    suspend fun searchLigands(proteinId: String): List<LigandInfo> {
        android.util.Log.d("PDBAPIService", "ğŸ” Ligands ê²€ìƒ‰: $proteinId")
        
        try {
            val url = "$dataBaseURL/entry/$proteinId/ligand"
            val request = Request.Builder()
                .url(url)
                .get()
                .build()
            
            val response = client.newCall(request).execute()
            
            if (response.isSuccessful) {
                val responseBody = response.body?.string()
                if (!responseBody.isNullOrEmpty()) {
                    val ligands = parseLigandsResponse(responseBody)
                    android.util.Log.d("PDBAPIService", "âœ… Ligands ê²€ìƒ‰ ì„±ê³µ: ${ligands.size}ê°œ")
                    return ligands
                }
            }
            
            android.util.Log.w("PDBAPIService", "âŒ Ligands ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ: $proteinId")
            return emptyList()
            
        } catch (e: Exception) {
            android.util.Log.e("PDBAPIService", "âŒ Ligands ê²€ìƒ‰ ì‹¤íŒ¨: ${e.message}")
            return emptyList()
        }
    }
    
    /**
     * Ligands ì‘ë‹µ íŒŒì‹±
     */
    private fun parseLigandsResponse(responseBody: String): List<LigandInfo> {
        return try {
            val jsonObject = JSONObject(responseBody)
            val ligands = mutableListOf<LigandInfo>()
            
            // PDB APIì˜ ligand êµ¬ì¡°ì— ë”°ë¼ íŒŒì‹±
            if (jsonObject.has("ligand")) {
                val ligandArray = jsonObject.getJSONArray("ligand")
                for (i in 0 until ligandArray.length()) {
                    val ligand = ligandArray.getJSONObject(i)
                    val ligandInfo = LigandInfo(
                        id = ligand.optString("pdbx_chem_comp_id", ""),
                        name = ligand.optString("pdbx_chem_comp_name", ""),
                        formula = ligand.optString("formula", ""),
                        molecularWeight = ligand.optDouble("formula_weight", 0.0),
                        type = ligand.optString("pdbx_type", ""),
                        description = ligand.optString("pdbx_description", ""),
                        isHighlighted = false,
                        isFocused = false
                    )
                    ligands.add(ligandInfo)
                }
            }
            
            ligands
        } catch (e: Exception) {
            android.util.Log.e("PDBAPIService", "âŒ Ligands íŒŒì‹± ì‹¤íŒ¨: ${e.message}")
            emptyList()
        }
    }
    
    /**
     * ì•„ì´í°ê³¼ ë™ì¼í•œ í…ìŠ¤íŠ¸ ê²€ìƒ‰
     */
    suspend fun searchProteinsByText(searchText: String, limit: Int = 100): List<ProteinInfo> {
        android.util.Log.d("PDBAPIService", "ğŸ” í…ìŠ¤íŠ¸ ê²€ìƒ‰: '$searchText'")
        
        try {
            val query = buildTextSearchQuery(searchText, limit)
            val response = executeSearchQuery(query)
            
            if (response.isSuccessful) {
                val responseBody = response.body?.string()
                if (!responseBody.isNullOrEmpty()) {
                    val searchResponse = parseSearchResponse(responseBody)
                    val proteins = searchResponse.map { entry ->
                        ProteinInfo(
                            id = entry.safeIdentifier,
                            name = entry.title ?: "Unknown Protein",
                            category = inferCategoryFromTitle(entry.title ?: ""),
                            description = entry.title ?: "No description available",
                            keywords = listOf()
                        )
                    }
                    android.util.Log.d("PDBAPIService", "âœ… í…ìŠ¤íŠ¸ ê²€ìƒ‰ ì„±ê³µ: ${proteins.size}ê°œ")
                    return proteins
                }
            }
            
            android.util.Log.w("PDBAPIService", "âŒ í…ìŠ¤íŠ¸ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ: $searchText")
            return emptyList()
            
        } catch (e: Exception) {
            android.util.Log.e("PDBAPIService", "âŒ í…ìŠ¤íŠ¸ ê²€ìƒ‰ ì‹¤íŒ¨: ${e.message}")
            return emptyList()
        }
    }
    
    /**
     * PDB ID ìœ íš¨ì„± ê²€ì‚¬ (ì•„ì´í°ê³¼ ë™ì¼)
     */
    private fun isValidPDBID(id: String): Boolean {
        val trimmed = id.trim()
        return trimmed.length == 4 && trimmed.all { it.isLetterOrDigit() }
    }
    
    /**
     * PDB ID ê²€ìƒ‰ ì¿¼ë¦¬ ìƒì„± (ì•„ì´í°ê³¼ ë™ì¼)
     */
    private fun buildPDBIDSearchQuery(pdbId: String): String {
        return """
        {
            "query": {
                "type": "terminal",
                "service": "text",
                "parameters": {
                    "attribute": "rcsb_entry_container_identifiers.entry_id",
                    "operator": "exact_match",
                    "value": "$pdbId"
                }
            },
            "return_type": "entry",
            "request_options": {
                "paginate": {
                    "start": 0,
                    "rows": 1
                }
            }
        }
        """.trimIndent()
    }
    
    /**
     * í…ìŠ¤íŠ¸ ê²€ìƒ‰ ì¿¼ë¦¬ ìƒì„± (ì•„ì´í°ê³¼ ë™ì¼)
     */
    private fun buildTextSearchQuery(searchText: String, limit: Int): String {
        return """
        {
            "query": {
                "type": "terminal",
                "service": "text",
                "parameters": {
                    "attribute": "struct.title",
                    "operator": "contains_words",
                    "value": "$searchText"
                }
            },
            "return_type": "entry",
            "request_options": {
                "paginate": {
                    "start": 0,
                    "rows": $limit
                }
            }
        }
        """.trimIndent()
    }
    
    
    /**
     * Ligands í•˜ì´ë¼ì´íŠ¸ ê¸°ëŠ¥
     */
    suspend fun highlightLigands(proteinId: String, ligandIds: List<String>): List<LigandInfo> {
        android.util.Log.d("PDBAPIService", "ğŸ¯ Ligands í•˜ì´ë¼ì´íŠ¸: $proteinId, ligands: $ligandIds")
        
        val allLigands = searchLigands(proteinId)
        return allLigands.map { ligand ->
            ligand.copy(
                isHighlighted = ligandIds.contains(ligand.id)
            )
        }
    }
    
    /**
     * Ligands focus ê¸°ëŠ¥
     */
    suspend fun focusLigands(proteinId: String, ligandId: String): LigandInfo? {
        android.util.Log.d("PDBAPIService", "ğŸ” Ligand focus: $proteinId, ligand: $ligandId")
        
        val allLigands = searchLigands(proteinId)
        return allLigands.find { it.id == ligandId }?.copy(
            isFocused = true
        )
    }
    
    /**
     * Ligands í•˜ì´ë¼ì´íŠ¸ ë° focus ì¡°í•© ê¸°ëŠ¥
     */
    suspend fun highlightAndFocusLigands(
        proteinId: String, 
        highlightIds: List<String>, 
        focusId: String?
    ): List<LigandInfo> {
        android.util.Log.d("PDBAPIService", "ğŸ¯ğŸ” Ligands í•˜ì´ë¼ì´íŠ¸+focus: $proteinId")
        
        val allLigands = searchLigands(proteinId)
        return allLigands.map { ligand ->
            ligand.copy(
                isHighlighted = highlightIds.contains(ligand.id),
                isFocused = ligand.id == focusId
            )
        }
    }
    
    /**
     * Ligands ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ìš© ìƒ˜í”Œ ë°ì´í„°
     */
    fun getSampleLigands(proteinId: String): List<LigandInfo> {
        android.util.Log.d("PDBAPIService", "ğŸ§ª ìƒ˜í”Œ Ligands ìƒì„±: $proteinId")
        
        return listOf(
            LigandInfo(
                id = "ATP",
                name = "Adenosine triphosphate",
                formula = "C10H16N5O13P3",
                molecularWeight = 507.18,
                type = "Nucleotide",
                description = "Energy currency of the cell",
                isHighlighted = false,
                isFocused = false
            ),
            LigandInfo(
                id = "ADP",
                name = "Adenosine diphosphate",
                formula = "C10H15N5O10P2",
                molecularWeight = 427.20,
                type = "Nucleotide",
                description = "ATP precursor",
                isHighlighted = true,
                isFocused = false
            ),
            LigandInfo(
                id = "AMP",
                name = "Adenosine monophosphate",
                formula = "C10H14N5O7P",
                molecularWeight = 347.22,
                type = "Nucleotide",
                description = "Basic nucleotide unit",
                isHighlighted = false,
                isFocused = true
            )
        )
    }
    
    /**
     * ì œëª©ì—ì„œ ì¹´í…Œê³ ë¦¬ ì¶”ë¡ 
     */
    private fun inferCategoryFromTitle(title: String): ProteinCategory {
        val lowerTitle = title.lowercase()
        return when {
            lowerTitle.contains("enzyme") || lowerTitle.contains("kinase") -> ProteinCategory.ENZYMES
            lowerTitle.contains("structural") || lowerTitle.contains("collagen") -> ProteinCategory.STRUCTURAL
            lowerTitle.contains("antibody") || lowerTitle.contains("immune") -> ProteinCategory.DEFENSE
            lowerTitle.contains("transport") || lowerTitle.contains("hemoglobin") -> ProteinCategory.TRANSPORT
            lowerTitle.contains("hormone") || lowerTitle.contains("insulin") -> ProteinCategory.HORMONES
            lowerTitle.contains("storage") || lowerTitle.contains("ferritin") -> ProteinCategory.STORAGE
            lowerTitle.contains("receptor") || lowerTitle.contains("gpcr") -> ProteinCategory.RECEPTORS
            lowerTitle.contains("membrane") || lowerTitle.contains("channel") -> ProteinCategory.MEMBRANE
            lowerTitle.contains("motor") || lowerTitle.contains("myosin") -> ProteinCategory.MOTOR
            lowerTitle.contains("signaling") || lowerTitle.contains("pathway") -> ProteinCategory.SIGNALING
            lowerTitle.contains("chaperone") || lowerTitle.contains("hsp") -> ProteinCategory.CHAPERONES
            lowerTitle.contains("metabolic") || lowerTitle.contains("metabolism") -> ProteinCategory.METABOLIC
            else -> ProteinCategory.ENZYMES // ê¸°ë³¸ê°’
        }
    }
}